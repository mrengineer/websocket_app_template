<!DOCTYPE html>  
<meta charset="utf-8" /> 
	
<head>
	<title>Swicheck</title>  


	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

	<script src="reconnecting-websocket.js"></script> <!-- https://github.com/joewalnes/reconnecting-websocket -->
	<script type="text/javascript" src="smoothie.js"></script> <!-- http://smoothiecharts.org -->

	<script language="javascript" type="text/javascript">  

	var wsUri = "ws://localhost:8080";
	var websocket;
	var connection;

	var g_magnitudes = null;
	var g_variance = null;
	var g_alg = null;


	//Series on drawing
	var magnitudes 	= new TimeSeries();
	var maxm 		= new TimeSeries();

	var variance 	= new TimeSeries();
	var maxv 		= new TimeSeries();

	var alg 		= new TimeSeries();

	function init() {
		connection 	= document.getElementById("connection");
		output 		= document.getElementById("output");
		variance_act = document.getElementById("variance_act");
		magnitudes_act = document.getElementById("magnitudes_act");
	
		websocket = new ReconnectingWebSocket(wsUri);
		websocket.reconnectInterval = 1000;

		websocket.onopen 	= function(evt) { onOpen(evt) }; 
		websocket.onclose 	= function(evt) { onClose(evt) }; 
		websocket.onmessage = function(evt) { onMessage(evt) }; 
		websocket.onerror 	= function(evt) { onError(evt) };	
	}

	function onOpen(evt) { 
		connection.innerHTML = "<span class=\"badge rounded-pill bg-success\">На связи</span>"; 
		websocket.send("?");		
	}
	function onClose(evt) { connection.innerHTML = "<span class=\"badge rounded-pill bg-danger\">Нет соединения</span>"; }
	function onError(evt) {
		connection.innerHTML = "<span class=\"badge rounded-pill bg-danger\">Нет соединения</span>"
	}
	function onMessage(message){
		if (message.data == "") return;

		try {
			
			args = String(message.data).split(" ");		
				var el 		= null;
				var el_id 	= args[0].toString().trim().toUpperCase();					

				if (el_id == "MAGN") {
					magnitudes.append(Date.now(), parseFloat(args[1].toString().trim()));
					maxm.append(Date.now(), parseFloat(args[2].toString().trim()));
					magnitudes_act.innerHTML =  parseFloat(args[1].toString().trim());
				} else if (el_id == "VAR") {
					variance.append(Date.now(), parseFloat(args[1].toString().trim()));					
					maxv.append(Date.now(), parseFloat(args[2].toString().trim()));
					variance_act.innerHTML =  parseFloat(args[1].toString().trim());					

				} else if (el_id == "ALG") {
					alg.append(Date.now(), parseFloat(args[1].toString().trim()));

				} else if (el_id == "CONSOLE") {
					el = document.getElementById(el_id);
					//console.log(message.data);
					el.innerHTML = message.data.toString().replace("CONSOLE", "").trim() + "<BR>" + el.innerHTML;
				} else {
					
					el = document.getElementById(el_id);
					evalue = args[1].toString().trim();

					//console.log(el_id + "=" + evalue);


					if (el != null) el.innerHTML = evalue;
					
					if (el_id =="STATE") {
						switch (parseInt(evalue)){
							case 0:
								el.innerHTML = "<span class=\"badge rounded-pill bg-secondary\">Простой</span>"
								break;
							case 1:
								el.innerHTML = "<span class=\"badge rounded-pill bg-primary\">Настройка усиления</span>"
								break;
							case 2:
								el.innerHTML = "<span class=\"badge rounded-pill bg-primary\">Калибровка</span>"
								break;
							case 3:
								el.innerHTML = "<span class=\"badge rounded-pill bg-success text-dark\">Ожидание импульса</span>"
								break;
							case 4:
								el.innerHTML = "<span class=\"badge rounded-pill bg-success text-dark\">ИМПУЛЬС</span>"
								break;
							case 5:
								el.innerHTML = "<span class=\"badge rounded-pill bg-danger text-dark\">Сбой</span>"
								break;				
							default:
								el.innerHTML = "<span class=\"badge rounded-pill bg-light text-dark\">Не определено</span>"
								break;						
						}
					}
				}			
		} catch (error) {
			console.error(error);
			console.log(message);
		}

	}

	function doSend(message) {	websocket.send(message); }

	window.onload = function () {
		
	}

	document.addEventListener("DOMContentLoaded", () => {init();});

	</script>
</head>
<body>

		Соединение: <span id="connection"><span class="badge rounded-pill bg-danger">Нет соединения</span></span> 
		<BR>
		Состояние: <span id="STATE"><span class="badge rounded-pill bg-light text-dark">Не определено</span></span>
		<HR>
		Усиление канала 1: <span id="GAIN0">-</span> dBm
		<BR>
		Усиление канала 2: <span id="GAIN1">-</span> dBm
		<HR> 
		Максимум магнитуды: <span id="MAXM">-</span> актуальное <span id="magnitudes_act">-</span>
		<BR>
		Максимум дисперсии: <span id="MAXV">-</span> актуальное <span id="variance_act">-</span>
		<BR>
		Производительность: <span id="PERF">-</span> отсчетов/мс
		<BR>
		Детектировано импульсов: <span id="PULSES">0</span>


		<canvas id="graph_magnitudes" width="500" height="150" style="width:100%;height:150px"></canvas>
		<canvas id="graph_variance" width="500" height="150" style="width:100%;height:150px"></canvas>
		<canvas id="graph_alg" width="500" height="150" style="width:100%;height:150px"></canvas>
		
		<div id="CONSOLE"></div>

		<script type="text/javascript">
			function myYRangeFunction(range) {
				var min = 0;
				var max = range.max*1.05;
				return {min: min, max: max};
			}

			var g_magnitudes = new SmoothieChart({ grid: { strokeStyle: 'rgb(025, 0, 0)', yRangeFunction:myYRangeFunction, fillStyle: 'rgb(0, 0, 0)', lineWidth: 1, millisPerLine: 200, verticalSections: 10 } });
			g_magnitudes.addTimeSeries(maxm, { strokeStyle: 'rgb(0, 255, 0)', lineWidth: 2 });
			g_magnitudes.addTimeSeries(magnitudes, { strokeStyle: 'rgb(0, 255, 0)', lineWidth: 1 });


			var g_variance = new SmoothieChart({ grid: { strokeStyle: 'rgb(025, 0, 0)', fillStyle: 'rgb(0, 0, 0)', lineWidth: 1, millisPerLine: 200, verticalSections: 10 } });
			g_variance.addTimeSeries(maxv, { strokeStyle: 'rgb(0, 0, 255)', lineWidth: 2 });
			g_variance.addTimeSeries(variance, { strokeStyle: 'rgb(0, 0, 255)', lineWidth: 1 });
			
			var g_alg = new SmoothieChart({ grid: { strokeStyle: 'rgb(025, 0, 0)', fillStyle: 'rgb(0, 0, 0)', lineWidth: 1, millisPerLine: 200, verticalSections: 4 } });
			g_alg.addTimeSeries(alg, { strokeStyle: 'rgb(0, 0, 255)', lineWidth: 2 });

			g_magnitudes.streamTo(document.getElementById("graph_magnitudes"), 600);
			g_variance.streamTo(document.getElementById("graph_variance"), 600);
			g_alg.streamTo(document.getElementById("graph_alg"), 600);
		  </script>

</body>

</html>